stages:
  - prep
  - build
  - test

sccache:
  stage: prep
  image: alpine:latest
  script:
    - wget -O $SCCACHE_TARBALL "https://github.com/mozilla/sccache/releases/download/${SCCACHE_VERSION}/sccache-${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz"
    - echo "$SCCACHE_SHA256  $SCCACHE_TARBALL" > ${SCCACHE_TARBALL}.sha256
    - sha256sum -c $SCCACHE_TARBALL.sha256
    - mkdir -p .gitlab
    - tar -C .gitlab --strip-components 1 -xf $SCCACHE_TARBALL sccache-${SCCACHE_VERSION}-x86_64-unknown-linux-musl/sccache
  variables:
    SCCACHE_TARBALL: sccache.tgz
    SCCACHE_VERSION: v0.8.0
    SCCACHE_SHA256: 2e0e7df61bc7dcf61fd65c1b345d05cd1f832598a15c6f42e7e21f86b8d39b1f
  artifacts:
    expire_in: 1 day
    paths:
      - .gitlab/sccache
  cache:
    key: sccache-$SCCACHE_VERSION
    paths: 
      - .gitlab/sccache
  interruptible: true

cargo-vendor:
  stage: prep
  image: rust:latest
  script:
    - mkdir -p .cargo
    - cargo fetch --locked
    - cargo vendor --locked .cargo/vendor > .cargo/config.toml
  artifacts:
    expire_in: 1 day
    paths:
      - .cargo/config.toml
      - .cargo/vendor
  cache:
    key:
      files:
        - Cargo.lock
    paths:
      - .cargo/config.toml
      - .cargo/vendor
  interruptible: true

rust-latest:
  stage: build
  image: rust:latest
  script:
    - cargo build --frozen --offline
    - .gitlab/sccache --show-stats
  interruptible: true
  cache:
    key: sccache-cargo-build-cache
    paths:
      - .cargo/sccache
  needs:
    - sccache
    - cargo-vendor
  variables:
    SCCACHE_DIR: /builds/nausicaea/rootspace/.cargo/sccache
    RUSTC_WRAPPER: .gitlab/sccache

cargo-check:
  stage: test
  image: rust:latest
  script:
    - cargo check --frozen --offline
    - .gitlab/sccache --show-stats
  interruptible: true
  cache:
    key: sccache-cargo-check-cache
    paths:
      - .cargo/sccache
  needs:
    - sccache
    - cargo-vendor
  variables:
    SCCACHE_DIR: /builds/nausicaea/rootspace/.cargo/sccache
    RUSTC_WRAPPER: .gitlab/sccache

rustfmt-check:
  stage: test
  image: rust:latest
  script:
    - rustup component add rustfmt
    - cargo --frozen --offline fmt -- --check
  interruptible: true
  needs:
    - cargo-vendor

cargo-clippy:
  stage: test
  image: rust:latest
  script:
    - rustup component add clippy
    - cargo clippy --frozen --offline --all-targets --all-features -- -Dwarnings
    - .gitlab/sccache --show-stats
  interruptible: true
  cache:
    key: sccache-cargo-clippy-cache
    paths:
      - .cargo/sccache
  needs:
    - sccache
    - cargo-vendor
  variables:
    SCCACHE_DIR: /builds/nausicaea/rootspace/.cargo/sccache
    RUSTC_WRAPPER: .gitlab/sccache

cargo-test:
  stage: test
  image: rust:latest
  script:
    - cargo test --frozen --offline
    - .gitlab/sccache --show-stats
  interruptible: true
  cache:
    key: sccache-cargo-test-cache
    paths:
      - .cargo/sccache
  needs:
    - sccache
    - cargo-vendor
  variables:
    SCCACHE_DIR: /builds/nausicaea/rootspace/.cargo/sccache
    RUSTC_WRAPPER: .gitlab/sccache
